<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaGen</title>
</head>

<!-- 공통 Grid Fragment -->
<div th:fragment="grid(tableId, dataUrl, crudActions)">
    <!-- CRUD 버튼 컨테이너 -->
    <div class="button-container mb-3">
        <button class="btn btn-primary grd-select" data-table-id="${tableId}" id="grd-select">조회</button>
        <button class="btn btn-primary grd-add" th:data-table-id="${tableId}" th:id="'grd-add-' + ${tableId}" style="display: none;">추가</button>
        <button class="btn btn-primary grd-save" th:data-table-id="${tableId}" th:id="'grd-save-' + ${tableId}" style="display: none;">저장</button>
        <button class="btn btn-secondary grd-delete" th:data-table-id="${tableId}" th:id="'grd-delete-' + ${tableId}" style="display: none;">삭제</button>
    </div>

    <table th:id="${tableId}" class="table table-striped table-bordered">
        <thead>
        <tr id="tableHeader"></tr>
        </thead>
    </table>

    <script th:inline="javascript">
        if (!window.tableInstances) {
            window.tableInstances = {};  // 여러 개의 DataTable을 저장할 객체
        }

        // CRUD 코드 매핑 (C = Create(Add), U = Update(Save), D = Delete)
        if (!window.crudActionMap) {
            window.crudActionMap = {
                "C": "add",
                "U": "save",
                "D": "delete"
            };
        }

        // `grid()` 함수 전역으로 선언하여 `dataDictionary.js`에서 호출 가능
        window.grid = function (tableId, dataUrl, crudActions = '') {
            console.log(` grid() 호출됨: tableId=${tableId}, dataUrl=${dataUrl}, crudActions=${crudActions}`);

            /* CRUD 버튼 표시 여부 처리 */
            if (crudActions.trim() !== '') {
                let actionsArray = crudActions.split("");
                actionsArray.forEach(action => {
                    let mappedAction = window.crudActionMap[action.trim().toUpperCase()]; // C → add, U → save, D → delete
                    if (mappedAction) {
                        let button = document.querySelector(`.grd-${mappedAction}[data-table-id="${tableId}"]`);
                        if (button) {
                            button.style.display = "inline-block";
                        }
                    }
                });
            }

            $(document).ready(function () {
                if (!tableId || !dataUrl) {
                    console.error("tableId 또는 dataUrl이 없습니다.");
                    return;
                }

                if (window.tableInstances[tableId]) {
                    return;
                }

                $.ajax({
                    url: `${dataUrl}/column`,
                    type: "GET",
                    success: function (columns) {
                        let headerRow = $("#" + tableId + " thead tr");
                        headerRow.empty();
                        columns.forEach(col => {
                            headerRow.append(`<th>${col.columnName}</th>`);
                        });

                        let defaultSortField = columns.some(col => col.column === "timestamp") ? "timestamp" : "id";

                        window.tableInstances[tableId] = $("#" + tableId).DataTable({
                            "processing": true,
                            "serverSide": true,
                            "searching": false,
                            "info": false,
                            "destroy": true,
                            "language": {
                                "lengthMenu": "페이지당 _MENU_ 행 표시",
                                "zeroRecords": "검색된 데이터가 없습니다.",
                                "info": "총 _TOTAL_ 개의 항목",
                                "infoEmpty": "표시할 데이터가 없습니다.",
                                "emptyTable": "조회된 데이터가 없습니다.",
                                "infoFiltered": "(전체 _MAX_ 개의 항목 중 필터링됨)",
                                "paginate": {
                                    "first": "처음",
                                    "last": "마지막",
                                    "next": "다음",
                                    "previous": "이전"
                                }
                            },
                            "ajax": {
                                "url": `${dataUrl}/data`,
                                "type": "GET",
                                "data": function (d) {
                                    return {
                                        page: d.start / d.length,
                                        size: d.length
                                    };
                                }
                            },
                            "columns": columns.map(col => ({
                                "data": col.column,
                                "title": col.columnName
                            }))
                        });
                    },
                    error: function (error) {
                        console.error("데이터 불러오기 실패:", error);
                    }
                });
            });
        };

        $(".grd-select").on("click", () => {
            if (Object.keys(window.tableInstances).length === 0) {
                console.warn("테이블 인스턴스가 없습니다.");
                return;
            }

            Object.values(window.tableInstances).forEach(instance => {
                if (instance.ajax) {
                    instance.ajax.reload();
                }
            });
        });

        $(document).ready(() => {
            let tableId = /*[[${tableId}]]*/ '';
            let dataUrl = /*[[${dataUrl}]]*/ '';
            let crudActions = /*[[${crudActions} ?: '']]*/ '';

            window.grid(tableId, dataUrl, crudActions);
        });
    </script>
</div>
</html>
